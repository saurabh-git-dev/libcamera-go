name: Build OpenCV

on:
  workflow_dispatch:

jobs:
  build-opencv:
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash
    env:
      OPENCV_VERSION: 4.13.0
      INSTALL_PREFIX: /usr/local
      BUILD_ROOT: /tmp/opencv-static-build
      DISABLE_GUI_VIDEO_BACKENDS: 1
      INSTALL_DEPS: 1
      FORCE_CLEAN: 1
      OPENCV_CACHE_KEY: ubuntu-24.04-opencv-static-4.13.0-guioff-1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore OpenCV cache
        id: restore-opencv-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /usr/local/include/opencv4
            /usr/local/lib/libopencv*.a
            /usr/local/lib/opencv4
            /usr/local/lib/cmake/opencv4
            /usr/local/lib/pkgconfig/opencv4.pc
          key: ${{ env.OPENCV_CACHE_KEY }}-${{ hashFiles('scripts/build-opencv-static.sh') }}

      - name: Build OpenCV static with project script
        if: steps.restore-opencv-cache.outputs.cache-hit != 'true'
        run: |
          chmod +x ./scripts/build-opencv-static.sh
          ./scripts/build-opencv-static.sh

      - name: Save OpenCV cache
        if: steps.restore-opencv-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            /usr/local/include/opencv4
            /usr/local/lib/libopencv*.a
            /usr/local/lib/opencv4
            /usr/local/lib/cmake/opencv4
            /usr/local/lib/pkgconfig/opencv4.pc
          key: ${{ steps.restore-opencv-cache.outputs.cache-primary-key }}
